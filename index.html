<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethical Hacking Career Roadmap - Modern UI (3D Graph)</title>
    <!-- Google Fonts: Poppins for sleek & modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Load scripts from CDN with defer attribute - Updated to match new example -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/3d-force-graph@1.77.0/dist/3d-force-graph.min.js" defer></script>
    
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            /* --- Base Variables --- */
            --font-primary: 'Poppins', sans-serif;
            --transition-speed: 0.3s ease-in-out;
            --border-radius-main: 16px;
            --border-radius-small: 8px;

            /* --- Light Mode Colors --- */
            --bg-light: #f0f2f5;
            --bg-glass-light: rgba(255, 255, 255, 0.6);
            --border-glass-light: rgba(255, 255, 255, 0.8);
            --text-primary-light: #1c1e21;
            --text-secondary-light: #555b6e;
            --accent-primary-light: #007aff;
            --accent-secondary-light: #34c759;
            --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.17);
            --node-text-light: #000000; /* Fallback, new graph script uses its own label colors */

            /* --- Dark Mode Colors --- */
            --bg-dark: #121212;
            --bg-glass-dark: rgba(40, 40, 40, 0.6);
            --border-glass-dark: rgba(70, 70, 70, 0.8);
            --text-primary-dark: #FFFFFF;
            --text-secondary-dark: #bdc1c6;
            --accent-primary-dark: #0a84ff;
            --accent-secondary-dark: #30d158;
            --shadow-dark: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --node-text-dark: #FFFFFF; /* Fallback, new graph script uses its own label colors */

            /* Node colors from your original theme - will be overridden by the new graph script's data */
            --foundational-fill-light: #e6ffb3;
            --foundational-stroke-light: #7cb342;
            /* ... other original node colors ... */
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { background-color: var(--bg-current); color: var(--text-primary-current); transition: background-color var(--transition-speed), color var(--transition-speed); }
        body { font-family: var(--font-primary); line-height: 1.6; overflow-x: hidden; min-height: 100vh; color: inherit; background-color: inherit; }

        html.dark-mode {
            --bg-current: var(--bg-dark); --bg-glass-current: var(--bg-glass-dark); --border-glass-current: var(--border-glass-dark);
            --text-primary-current: var(--text-primary-dark); --text-secondary-current: var(--text-secondary-dark);
            --accent-primary-current: var(--accent-primary-dark); --accent-secondary-current: var(--accent-secondary-dark);
            --shadow-current: var(--shadow-dark); --node-text-current: var(--node-text-dark);
            /* ... other dark mode specific overrides if needed ... */
        }
        html:not(.dark-mode) {
            --bg-current: var(--bg-light); --bg-glass-current: var(--bg-glass-light); --border-glass-current: var(--border-glass-light);
            --text-primary-current: var(--text-primary-light); --text-secondary-current: var(--text-secondary-light);
            --accent-primary-current: var(--accent-primary-light); --accent-secondary-current: var(--accent-secondary-light);
            --shadow-current: var(--shadow-light); --node-text-current: var(--node-text-light);
            /* ... other light mode specific overrides if needed ... */
        }
        
        .page-wrapper { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 30px; }
        .page-title { font-size: 2.5em; font-weight: 700; color: var(--accent-primary-current); letter-spacing: -0.5px; transition: color var(--transition-speed); }
        .dark-mode-toggle { display: flex; align-items: center; cursor: pointer; }
        .dark-mode-toggle input[type="checkbox"] { display: none; }
        .toggle-slider { width: 50px; height: 26px; background-color: #ccc; border-radius: 26px; position: relative; transition: background-color var(--transition-speed); }
        .toggle-slider::before { content: ''; position: absolute; width: 22px; height: 22px; border-radius: 50%; background-color: white; top: 2px; left: 2px; transition: transform var(--transition-speed); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .dark-mode-toggle input:checked + .toggle-slider { background-color: var(--accent-primary-current); }
        .dark-mode-toggle input:checked + .toggle-slider::before { transform: translateX(24px); }
        .toggle-icon { margin-left: 10px; font-size: 1.2em; color: var(--text-secondary-current); transition: color var(--transition-speed); }
        html.dark-mode .toggle-icon { color: var(--accent-primary-current); }

        .content-section { background: var(--bg-glass-current); border: 1px solid var(--border-glass-current); border-radius: var(--border-radius-main); padding: 25px; margin-bottom: 30px; box-shadow: var(--shadow-current); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); transition: background var(--transition-speed), border var(--transition-speed), box-shadow var(--transition-speed), color var(--transition-speed); }
        .content-section h3 { font-size: 1.5em; font-weight: 600; color: var(--accent-primary-current); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--accent-primary-current); transition: color var(--transition-speed), border-color var(--transition-speed); }
        .content-section p, .content-section li { color: var(--text-secondary-current); font-size: 0.95em; margin-bottom: 10px; transition: color var(--transition-speed); }
        .content-section strong { color: var(--text-primary-current); font-weight: 600; transition: color var(--transition-speed); }

        /* Styles for the graph container itself. The new graph script sets its own background. */
        #visNetwork { 
            height: 700px; 
            width: 100%; 
            /* background-color: transparent; NO - new script controls this */
            border-radius: var(--border-radius-small); 
            cursor: grab; 
            border: 2px solid var(--border-glass-current); 
            position: relative; /* Needed for loading message */
        }
        #visNetwork:active { cursor: grabbing; }

        .legend ul { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .legend li { color: var(--text-secondary-current); padding: 8px 0; border-bottom: 1px dashed var(--border-glass-current); transition: border-color var(--transition-speed), color var(--transition-speed); }
        .legend li:last-child { border-bottom: none; }
        /* Legend colors would need to be updated if you want them to match the new graph node colors */
        .legend-color { font-weight: 600; }
        /* Example: .foundational-legend-color { color: #FF6F61; } /* Reconnaissance color */

        .soft-skill-text, .resource-text { color: var(--text-secondary-current); transition: color var(--transition-speed); }
        
        .accordion-item { margin-bottom: 15px; border-radius: var(--border-radius-small); overflow: hidden; border: 1px solid var(--border-glass-current); transition: border-color var(--transition-speed); }
        .accordion-header { background-color: rgba(0,0,0,0.03); padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color var(--transition-speed); }
        html.dark-mode .accordion-header { background-color: rgba(255,255,255,0.05); }
        .accordion-header:hover { background-color: rgba(0,0,0,0.06); }
        html.dark-mode .accordion-header:hover { background-color: rgba(255,255,255,0.08); }
        .accordion-header strong { font-size: 1.1em; color: var(--text-primary-current); }
        .accordion-icon { font-size: 1em; color: var(--accent-primary-current); transition: transform var(--transition-speed); }
        .accordion-item.active .accordion-icon { transform: rotate(45deg); }
        .accordion-content { max-height: 0; overflow: hidden; padding: 0 20px; background-color: transparent; transition: max-height 0.4s ease-out, padding var(--transition-speed); }
        .accordion-item.active .accordion-content { max-height: 1000px; padding: 20px; }
        .accordion-content ul { list-style-position: inside; padding-left: 5px; }
        .accordion-content ul li { margin-bottom: 8px; }

        .loading-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2em; color: var(--text-secondary-current); text-align: center; padding: 20px; }

        /* Node info panel is not directly used by the new graph script for on-click info */
        #node-info-panel { display: none; /* Hide if not used by new graph */ }

        @media (max-width: 768px) {
            .page-title { font-size: 2em; } .page-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .content-section { padding: 20px; } .legend ul { grid-template-columns: 1fr; } #visNetwork { height: 500px; } 
            .accordion-header strong { font-size: 1em; }
        }
        @media (max-width: 480px) {
            .page-title { font-size: 1.8em; } .content-section h3 { font-size: 1.3em; } #visNetwork { height: 450px; }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header class="page-header">
            <h1 class="page-title">Ethical Hacking Roadmap (3D)</h1>
            <label class="dark-mode-toggle" for="darkModeToggle" aria-label="Toggle dark mode">
                <input type="checkbox" id="darkModeToggle">
                <span class="toggle-slider"></span>
                <i class="fas fa-moon toggle-icon" id="modeIcon"></i>
            </label>
        </header>

        <section class="content-section" id="roadmap-visualization">
            <h3>Career Visualization (3D)</h3>
            <div id="visNetwork"> {/* The new graph script targets this ID */}
                <div class="loading-message">Loading 3D Graph Libraries... <br>If this persists, please check your browser's Network and Console tabs for errors.</div>
            </div>
        </section>
        <div id="node-info-panel"></div> 


        <section class="content-section" id="legend-section">
            <h3>Legend</h3>
            <p>Note: Legend colors below are from the original theme. The graph uses new colors defined in its data.</p>
            <ul class="legend">
                <li><strong class="legend-color" style="color: #FF6F61">● Reconnaissance Category</strong></li>
                <li><strong class="legend-color" style="color: #61A0FF">● Scanning Category</strong></li>
                <li><strong class="legend-color" style="color: #6BFF96">● Exploitation Category</strong></li>
            
            </ul>
        </section>

        <section class="content-section" id="learning-path">
            <h3>Recommended Learning Path</h3>
            <div class="accordion">
                <div class="accordion-item">
                    <div class="accordion-header">
                        <strong>Phase 1: Foundational & Basic (3-9 months)</strong>
                        <i class="fas fa-plus accordion-icon"></i>
                    </div>
                    <div class="accordion-content">
                        <ul>
                            <li><strong>Foundational:</strong> Dive deep into computer architecture, operating systems (especially Linux), networking (TCP/IP, common protocols, routing), and strong programming logic (Python, C, Bash are key). Understand fundamental data structures, algorithms, and OS internals.</li>
                            <li><strong>Basic Security:</strong> Grasp cybersecurity principles, common vulnerabilities (OWASP Top 10 intro), basic command-line tools, and ethical considerations.</li>
                            <li><strong>Certifications:</strong> CompTIA A+, Network+, Security+ are excellent starting points.</li>
                        </ul>
                    </div>
                </div>
                <div class="accordion-item">
                    <div class="accordion-header">
                        <strong>Phase 2: Intermediate Specialization (6-18 months)</strong>
                        <i class="fas fa-plus accordion-icon"></i>
                    </div>
                    <div class="accordion-content">
                        <ul>
                            <li><strong>Web Security:</strong> Focus on web application vulnerabilities, secure coding, web proxies (Burp Suite).</li>
                            <li><strong>Network Security:</strong> Learn firewall concepts, IDS/IPS, VPNs, and network scanning tools (Nmap).</li>
                            <li><strong>Cryptography:</strong> Understand ciphers, hashing, PKI, and common crypto attacks.</li>
                            <li><strong>Digital Forensics:</strong> Basic incident response, evidence collection, and analysis tools.</li>
                            <li><strong>Cloud & Mobile Security Basics:</strong> Introduction to specific vulnerabilities and best practices for common platforms.</li>
                            <li><span class="soft-skill-text"><strong>Communication & Documentation:</strong></span> Vital for explaining findings and creating reports.</li>
                            <li><strong>Certifications:</strong> EC-Council CEH, eJPT, PNPT, GIAC GSEC.</li>
                        </ul>
                    </div>
                </div>
                <div class="accordion-item">
                    <div class="accordion-header">
                        <strong>Phase 3: Advanced Deep Dive (1-3 years)</strong>
                        <i class="fas fa-plus accordion-icon"></i>
                    </div>
                    <div class="accordion-content">
                        <ul>
                           <li><strong>Malware Analysis:</strong> Static and dynamic analysis techniques, sandboxing, behavioral analysis.</li>
                            <li><strong>Reverse Engineering:</strong> Disassemblers (IDA Pro, Ghidra), debuggers (x64dbg), understanding assembly.</li>
                            <li><strong>Exploitation Development:</strong> Buffer overflows, ROP chains, shellcoding, heap exploitation, kernel exploitation.</li>
                            <li><strong>Advanced Cloud/Mobile Security:</strong> Deep dive into specific cloud provider vulnerabilities, mobile app reverse engineering.</li>
                            <li><strong>Active Directory/Enterprise Security:</strong> Understanding large network attack vectors.</li>
                            <li><strong>DevSecOps:</strong> Integrating security into the SDLC.</li>
                            <li><strong>Threat Intelligence:</strong> Gathering, analyzing, and acting on threat data.</li>
                            <li><strong>GRC (Governance, Risk, Compliance):</strong> Frameworks, policies, and regulations.</li>
                            <li><strong>Fuzzing:</strong> Finding vulnerabilities through automated input generation.</li>
                            <li><strong>Certifications:</strong> OSCP, OSWE, OSEP, CRTP, SANS GIAC (GPEN, GWAPT, GMON).</li>
                        </ul>
                    </div>
                </div>
                 <div class="accordion-item">
                    <div class="accordion-header">
                        <strong>Phase 4: Expert & Research (2+ years)</strong>
                        <i class="fas fa-plus accordion-icon"></i>
                    </div>
                    <div class="accordion-content">
                        <ul>
                            <li><strong>Security Research & Development:</strong> Identifying new vulnerabilities, advanced threat modeling, developing custom tools.</li>
                            <li><strong>Zero-Day Discovery:</strong> Advanced techniques for finding previously unknown vulnerabilities.</li>
                            <li><strong>Advanced Forensics & Incident Response:</strong> Memory forensics, malware attribution, complex incident reconstruction.</li>
                            <li><strong>IoT/OT Security:</strong> Specialized knowledge for embedded systems, industrial control systems.</li>
                            <li><strong>Certifications:</strong> OSEE, OSCE3, SANS GSE, CREST.</li>
                            <li><span class="soft-skill-text"><strong>Mentorship & Leadership:</strong></span> Guiding professionals, leading initiatives.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section class="content-section" id="certifications-path">
            <h3>Certifications Path</h3>
            <p>Practical experience and continuous learning are paramount. Focus on hands-on labs.</p>
            <ul>
                <li><strong>Foundational/Basic:</strong> CompTIA A+, Network+, Security+</li>
                <li><strong>Intermediate:</strong> CEH, eJPT, PNPT, GIAC GSEC</li>
                <li><strong>Advanced:</strong> OSCP, OSWE, OSEP, CRTP, CISSP, GIAC (GPEN, GWAPT, GMON)</li>
                <li><strong>Expert:</strong> OSEE, OSCE3, SANS GSE, CREST certifications</li>
            </ul>
        </section>

        <section class="content-section" id="soft-skills">
            <h3>Crucial Soft Skills</h3>
            <ul>
                <li><span class="soft-skill-text"><strong>Ethics & Integrity:</strong></span> Paramount. Adhere to legal/ethical boundaries.</li>
                <li><span class="soft-skill-text"><strong>Problem Solving:</strong></span> Deconstruct puzzles, find creative solutions.</li>
                <li><span class="soft-skill-text"><strong>Communication:</strong></span> Articulate risks and findings clearly.</li>
                <li><span class="soft-skill-text"><strong>Continuous Learning:</strong></span> Cybersecurity evolves constantly.</li>
                <li><span class="soft-skill-text"><strong>Attention to Detail:</strong></span> Identify subtle vulnerabilities.</li>
                <li><span class="soft-skill-text"><strong>Patience & Persistence:</strong></span> Hacking involves trial and error.</li>
                <li><span class="soft-skill-text"><strong>Teamwork & Collaboration:</strong></span> Work with diverse teams.</li>
                <li><span class="soft-skill-text"><strong>Adaptability:</strong></span> Quickly learn new tech and methods.</li>
            </ul>
        </section>

        <section class="content-section" id="learning-resources">
            <h3>Recommended Learning Resources</h3>
            <ul>
                <li><span class="resource-text"><strong>Platforms:</strong> TryHackMe, Hack The Box, PortSwigger Web Security Academy, PentesterLab.</span></li>
                <li><span class="resource-text"><strong>Books:</strong> "Hacking: The Art of Exploitation", "Web App Hacker's Handbook".</span></li>
                <li><span class="resource-text"><strong>CTFs:</strong> Participate via CTFTime.org.</span></li>
                <li><span class="resource-text"><strong>Labs:</strong> Build a home lab (VirtualBox, VMware).</span></li>
                <li><span class="resource-text"><strong>Community:</strong> Blogs, forums (r/netsec), Discord servers.</span></li>
                <li><span class="resource-text"><strong>Events:</strong> Conferences (Black Hat, DEF CON) & local meetups.</span></li>
                <li><span class="resource-text"><strong>Open Source:</strong> Study/contribute to tools (Metasploit, Nmap).</span></li>
            </ul>
        </section>
    </div>

    <script>
        // Global variables for theme handling (dark mode toggle)
        const darkModeToggle = document.getElementById('darkModeToggle');
        const modeIcon = document.getElementById('modeIcon');
        const getCssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

        function applyTheme() {
            if (darkModeToggle.checked) {
                document.documentElement.classList.add('dark-mode');
                modeIcon.classList.remove('fa-moon'); modeIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark-mode');
                modeIcon.classList.remove('fa-sun'); modeIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
            // The new graph script sets its own background color directly.
            // If other elements need color updates based on theme, add them here.
            const graphContainer = document.getElementById('visNetwork');
            if (graphContainer) {
                graphContainer.style.border = `2px solid ${getCssVar('--border-glass-current')}`;
            }
        }

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') { darkModeToggle.checked = true; }
        applyTheme(); 
        darkModeToggle.addEventListener('change', applyTheme);

        // Accordion functionality
        document.addEventListener('DOMContentLoaded', () => {
            const accordions = document.querySelectorAll('.accordion-item');
            accordions.forEach(accordion => {
                const header = accordion.querySelector('.accordion-header');
                header.addEventListener('click', () => {
                    accordion.classList.toggle('active');
                    const content = accordion.querySelector('.accordion-content');
                    if (accordion.classList.contains('active')) {
                        content.style.maxHeight = content.scrollHeight + "px";
                    } else {
                        content.style.maxHeight = 0;
                    }
                });
            });

            // Function to attempt graph initialization
            function attemptInitGraph(retries = 5, delay = 300) {
                const graphContainer = document.getElementById('visNetwork'); // Corrected target ID
                const loadingMessageElement = graphContainer.querySelector('.loading-message');
                let allLibsLoaded = true; let missingLibs = [];

                if (typeof THREE === 'undefined') { allLibsLoaded = false; missingLibs.push('THREE.js'); }
                if (typeof ForceGraph3D === 'undefined') { allLibsLoaded = false; missingLibs.push('ForceGraph3D'); }
                
                if (allLibsLoaded) {
                    if (loadingMessageElement) loadingMessageElement.textContent = "Libraries loaded. Initializing 3D Graph...";
                    console.log("All required libraries loaded. Initializing graph...");
                    console.log("Three.js version detected:", (typeof THREE !== 'undefined' ? THREE.REVISION : 'N/A'));
                    initNewGraph(); // Call the new graph initialization function
                } else {
                    console.warn(`Libs not yet available. Missing: ${missingLibs.join(', ')}. Retrying (${retries} left)...`);
                    if (loadingMessageElement) {
                         loadingMessageElement.innerHTML = `Waiting for 3D Graph Libraries... <br>Missing: ${missingLibs.join(', ')}. Retrying... (${retries} left) <br>If this persists, ensure your browser can load scripts from CDNs.`;
                    }
                    if (retries > 0) { setTimeout(() => attemptInitGraph(retries - 1, delay), delay); }
                    else {
                        console.error("Failed to detect 3D graph libraries. Check Network/Console tabs for script load errors or earlier JS errors.");
                        if (loadingMessageElement) {
                            loadingMessageElement.innerHTML = "Error: Failed to load 3D graph components. <br>Please check your browser's <b>Network tab</b> for failed script loads and the <b>Console tab</b> for other errors, then refresh.";
                            loadingMessageElement.style.color = "red";
                        }
                    }
                }
            }
            attemptInitGraph();
        });

        // ===================================================================================
        // == START OF REPLACED GRAPH SCRIPT (FROM YOUR NEW EXAMPLE) ==
        // ===================================================================================
        function initNewGraph() {
            const graphContainer = document.getElementById('visNetwork'); // Target the existing container
            const loadingMessageElement = graphContainer.querySelector('.loading-message');
            if (loadingMessageElement) loadingMessageElement.style.display = 'none';


            // Utility for drawing rounded rectangle on canvas
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                if (w < 2 * r) r = w / 2;
                if (h < 2 * r) r = h / 2;
                this.beginPath();
                this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r);
                this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r);
                this.arcTo(x, y, x + w, y, r);
                this.closePath();
                return this;
            };

            // Data with colors, shapes and sizes (FROM YOUR NEW EXAMPLE)
            const data = {
                nodes: [
                    { id: 'Reconnaissance', color: '#FF6F61', shape: 'sphere', size: 9 },
                    { id: 'Footprinting', color: '#FF9A8D', shape: 'cube', size: 6 },
                    { id: 'WHOIS Information', color: '#FF9A8D', shape: 'cube', size: 6 },
                    { id: 'DNS Enumeration', color: '#FF9A8D', shape: 'cube', size: 6 },

                    { id: 'Scanning', color: '#61A0FF', shape: 'cone', size: 9 },
                    { id: 'Network Scanning', color: '#8AB8FF', shape: 'sphere', size: 5 },
                    { id: 'Port Scanning', color: '#8AB8FF', shape: 'sphere', size: 5 },
                    { id: 'Vulnerability Scanning', color: '#8AB8FF', shape: 'sphere', size: 5 },

                    { id: 'Exploitation', color: '#6BFF96', shape: 'sphere', size: 9 },
                    { id: 'System Hacking', color: '#9EFFB7', shape: 'cube', size: 6 },
                    { id: 'Password Cracking', color: '#9EFFB7', shape: 'cube', size: 6 },
                    { id: 'Privilege Escalation', color: '#9EFFB7', shape: 'cube', size: 6 },

                    { id: 'Post-Exploitation', color: '#FFE66B', shape: 'cone', size: 9 },
                    { id: 'Maintaining Access', color: '#FFF299', shape: 'sphere', size: 5 },
                    { id: 'Clearing Logs', color: '#FFF299', shape: 'sphere', size: 5 },
                    { id: 'Data Exfiltration', color: '#FFF299', shape: 'sphere', size: 5 },

                    { id: 'Defense Evasion', color: '#FF61B6', shape: 'sphere', size: 9 },
                    { id: 'Evading IDS/Firewalls', color: '#FF8FD1', shape: 'cube', size: 6 },
                    { id: 'Tunneling', color: '#FF8FD1', shape: 'cube', size: 6 },
                    { id: 'Rootkits', color: '#FF8FD1', shape: 'cube', size: 6 },

                    { id: 'Web Hacking', color: '#4B6AFF', shape: 'cone', size: 9 },
                    { id: 'SQL Injection', color: '#7A9BFF', shape: 'sphere', size: 5 },
                    { id: 'Cross-Site Scripting (XSS)', color: '#7A9BFF', shape: 'sphere', size: 5 },
                    { id: 'Cross-Site Request Forgery (CSRF)', color: '#7A9BFF', shape: 'sphere', size: 5 },

                    { id: 'Cryptography', color: '#A661FF', shape: 'sphere', size: 9 },
                    { id: 'Hashing', color: '#C19BFF', shape: 'cube', size: 6 },
                    { id: 'Encryption', color: '#C19BFF', shape: 'cube', size: 6 },
                    { id: 'Digital Signatures', color: '#C19BFF', shape: 'cube', size: 6 },

                    { id: 'Social Engineering', color: '#FFB661', shape: 'sphere', size: 9 },
                    { id: 'Phishing', color: '#FFD199', shape: 'cone', size: 5 },
                    { id: 'Pretexting', color: '#FFD199', shape: 'cone', size: 5 },
                    { id: 'Baiting', color: '#FFD199', shape: 'cone', size: 5 },
                ],
                links: [
                    { source: 'Reconnaissance', target: 'Footprinting' },
                    { source: 'Reconnaissance', target: 'WHOIS Information' },
                    { source: 'Reconnaissance', target: 'DNS Enumeration' },

                    { source: 'Scanning', target: 'Network Scanning' },
                    { source: 'Scanning', target: 'Port Scanning' },
                    { source: 'Scanning', target: 'Vulnerability Scanning' },

                    { source: 'Exploitation', target: 'System Hacking' },
                    { source: 'Exploitation', target: 'Password Cracking' },
                    { source: 'Exploitation', target: 'Privilege Escalation' },

                    { source: 'Post-Exploitation', target: 'Maintaining Access' },
                    { source: 'Post-Exploitation', target: 'Clearing Logs' },
                    { source: 'Post-Exploitation', target: 'Data Exfiltration' },

                    { source: 'Defense Evasion', target: 'Evading IDS/Firewalls' },
                    { source: 'Defense Evasion', target: 'Tunneling' },
                    { source: 'Defense Evasion', target: 'Rootkits' },

                    { source: 'Web Hacking', target: 'SQL Injection' },
                    { source: 'Web Hacking', target: 'Cross-Site Scripting (XSS)' },
                    { source: 'Web Hacking', target: 'Cross-Site Request Forgery (CSRF)' },

                    { source: 'Cryptography', target: 'Hashing' },
                    { source: 'Cryptography', target: 'Encryption' },
                    { source: 'Cryptography', target: 'Digital Signatures' },

                    { source: 'Social Engineering', target: 'Phishing' },
                    { source: 'Social Engineering', target: 'Pretexting' },
                    { source: 'Social Engineering', target: 'Baiting' },

                    { source: 'Reconnaissance', target: 'Scanning' },
                    { source: 'Scanning', target: 'Exploitation' },
                    { source: 'Exploitation', target: 'Post-Exploitation' },
                    { source: 'Post-Exploitation', target: 'Defense Evasion' },
                    { source: 'Defense Evasion', target: 'Web Hacking' },
                    { source: 'Web Hacking', target: 'Cryptography' },
                    { source: 'Social Engineering', target: 'Reconnaissance' },
                ]
            };
            
            // Data Validation (keeping this crucial check)
            const nodeIds = new Set(data.nodes.map(n => n.id));
            let missingSourceOrTarget = false;
            data.links.forEach((link, index) => {
                if (!nodeIds.has(link.source)) {
                    console.error(`Link index ${index} (source: "${link.source}", target: "${link.target}") references MISSING SOURCE node ID: "${link.source}"`);
                    missingSourceOrTarget = true;
                }
                if (!nodeIds.has(link.target)) {
                    console.error(`Link index ${index} (source: "${link.source}", target: "${link.target}") references MISSING TARGET node ID: "${link.target}"`);
                    missingSourceOrTarget = true;
                }
            });

            if (missingSourceOrTarget) {
                console.error("CRITICAL: Graph data is invalid. Fix data and refresh.");
                if (loadingMessageElement) {
                    loadingMessageElement.innerHTML = `Error: Graph data is invalid. Some links reference non-existent nodes. <br>Please check the browser console for details. <br>Graph cannot be displayed.`;
                    loadingMessageElement.style.color = "red";
                    loadingMessageElement.style.display = "block";
                }
                return;
            } else {
                console.log("Graph data integrity check: All link sources/targets valid.");
            }


            // Create a text sprite with rounded background for each label
            function createTextLabel(text) {
                const fontSize = 30; 
                const padding = 25;  

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                ctx.font = `${fontSize}px Arial`;
                const textWidth = ctx.measureText(text).width;
                const width = textWidth + padding * 2;
                const height = fontSize + padding * 2;

                canvas.width = width * 2; 
                canvas.height = height * 2;
                ctx.scale(2, 2);

                ctx.fillStyle = 'rgba(50, 50, 50, 0.85)';
                ctx.roundRect(0, 0, width, height, 15);
                ctx.fill();

                ctx.fillStyle = 'white';
                ctx.textBaseline = 'top';
                ctx.fillText(text, padding, padding);

                const texture = new THREE.CanvasTexture(canvas);
                texture.minFilter = THREE.LinearFilter; 

                const material = new THREE.SpriteMaterial({ map: texture, depthTest: false });
                const sprite = new THREE.Sprite(material);
                sprite.scale.set(width / 8, height / 8, 1); 
                return sprite;
            }

            // Function to create custom shapes (sphere, cube, cone)
            function createNodeShape(node) {
                let geometry;
                const size = node.size || 5;

                switch (node.shape) {
                    case 'cube':
                        geometry = new THREE.BoxGeometry(size, size, size);
                        break;
                    case 'cone':
                        geometry = new THREE.ConeGeometry(size / 1.5, size * 2, 8);
                        break;
                    case 'sphere':
                    default:
                        geometry = new THREE.SphereGeometry(size);
                        break;
                }
                const material = new THREE.MeshPhongMaterial({ color: node.color || '#ff6600', shininess: 60 });
                return new THREE.Mesh(geometry, material);
            }

            // Setup lighting (This needs to be done on the graph's internal scene)
            // The new graph script handles its own scene, so we modify how lights are added.

            try {
                const Graph = ForceGraph3D()
                    (graphContainer) // Use the existing container
                    .graphData(data)
                    .nodeThreeObject(node => {
                        const obj = createNodeShape(node);
                        const label = createTextLabel(node.id);
                        label.position.set(0, (node.size || 5) + 5, 0); 
                        obj.add(label);
                        return obj;
                    })
                    .linkWidth(1)
                    .linkColor(() => 'rgba(255,255,255,0.15)')
                    .backgroundColor('#121212') // Explicitly set from new script
                    .enableNodeDrag(true)
                    .cooldownTicks(100)
                    .onNodeClick(node => {
                        // The new script has an alert, you might want to integrate this with your nodeInfoPanel later
                        alert(`You clicked on: ${node.id}`);
                        // Example: If you want to use your old nodeInfoPanel:
                        // const nodeInfoPanel = document.getElementById('node-info-panel');
                        // if (nodeInfoPanel) {
                        //    nodeInfoPanel.innerHTML = `<h4>${node.id}</h4><p>Shape: ${node.shape}, Color: ${node.color}</p>`;
                        //    nodeInfoPanel.style.display = 'block'; // Make it visible
                        // }
                    })
                    .onBackgroundClick(() => {
                        // Example: If you want to hide your old nodeInfoPanel:
                        // const nodeInfoPanel = document.getElementById('node-info-panel');
                        // if (nodeInfoPanel) nodeInfoPanel.style.display = 'none';
                    });

                // Add lights to the graph's scene
                const light = new THREE.DirectionalLight(0xffffff, 0.8);
                light.position.set(50, 50, 100);
                Graph.scene().add(light);
                const ambientLight = new THREE.AmbientLight(0x404040, 0.7); // 0x404040 is a common grey
                Graph.scene().add(ambientLight);

                Graph.cameraPosition({ z: 100 }); // Initial camera position

                // Handle window resize for the new graph instance
                window.addEventListener('resize', () => {
                    Graph.width(graphContainer.clientWidth).height(graphContainer.clientHeight);
                });

            } catch (error) {
                 console.error("Error during new ForceGraph3D initialization:", error);
                if (loadingMessageElement) {
                    loadingMessageElement.innerHTML = `Error initializing 3D graph. <br>Three.js Version: ${typeof THREE !== 'undefined' ? THREE.REVISION : 'N/A'}<br>Error: ${error.message} <br>Check console for stack trace.`;
                    loadingMessageElement.style.color = "red";
                    loadingMessageElement.style.display = "block";
                }
            }
        }
        // ===================================================================================
        // == END OF REPLACED GRAPH SCRIPT ==
        // ===================================================================================
    </script>
</body>
</html>
